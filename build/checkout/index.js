(()=>{const t=("undefined"!=typeof wpApiSettings&&wpApiSettings?.root||"/wp-json/")+"wp-abilities/v1/abilities/",e="undefined"!=typeof wpApiSettings&&wpApiSettings?.nonce||"";async function s(s,i,o="POST"){const r={"X-WP-Nonce":e};let n=t+s+"/run",a=null;if("GET"===o){const t=new URLSearchParams;for(const[e,s]of Object.entries(i))void 0!==s&&t.append(`input[${e}]`,String(s));n+="?"+t.toString()}else r["Content-Type"]="application/json",a=JSON.stringify({input:i});const c=await fetch(n,{method:o,headers:r,body:a}),l=await c.json();if(!c.ok)throw new Error(l.message||l.error||"Ability call failed");return l}function i(t){const e=document.createElement("div");return e.appendChild(document.createTextNode(t||"")),e.innerHTML}const o={el:null,processing:!1,currentImage:null,pollTimer:null,init(){this.el=document.getElementById("smi-modal"),this.el&&this.bindEvents()},bindEvents(){document.addEventListener("click",t=>{const e=t.target.closest(".smi-buy-button");e&&(t.preventDefault(),this.open(e))}),this.el.querySelector(".smi-modal-close")?.addEventListener("click",()=>this.close()),this.el.querySelector(".smi-modal-overlay")?.addEventListener("click",()=>this.close()),document.addEventListener("keydown",t=>{"Escape"!==t.key||this.processing||this.close()}),this.el.addEventListener("click",t=>{t.target.closest(".smi-process-btn")&&(t.preventDefault(),this.processCheckout())}),this.handleReturnFromStripe()},async open(t){if(!this.processing&&(this.currentImage={attachmentId:parseInt(t.dataset.attachmentId||"0",10),postId:parseInt(t.dataset.postId||"0",10),src:t.dataset.src||"",width:parseInt(t.dataset.width||"0",10),height:parseInt(t.dataset.height||"0",10)},this.currentImage.attachmentId&&this.currentImage.postId)){this.show(),this.showLoading(!0),this.trackClick();try{const t=await s("sell-my-images/calculate-prices",{attachment_id:this.currentImage.attachmentId,post_id:this.currentImage.postId},"GET");this.renderPricing(t),this.showLoading(!1)}catch(t){this.showError(t instanceof Error?t.message:"Failed to load prices")}}},close(){this.processing||(this.el.classList.add("smi-hidden"),document.body.style.overflow="",this.clearPoll())},show(){this.el.classList.remove("smi-hidden"),document.body.style.overflow="hidden",this.clearError()},showLoading(t){this.el.querySelector(".smi-loading")?.classList.toggle("smi-hidden",!t),this.el.querySelector(".smi-modal-main")?.classList.toggle("smi-hidden",t)},showError(t){const e=this.el.querySelector(".smi-error-message"),s=this.el.querySelector(".smi-error-text");e&&s&&(s.textContent=t,e.classList.remove("smi-hidden")),this.showLoading(!1),this.resetProcessButton()},clearError(){this.el.querySelector(".smi-error-message")?.classList.add("smi-hidden")},renderPricing(t){const e=this.el.querySelector(".smi-modal-main");if(!e||!this.currentImage)return;const s=this.currentImage,o=t.prices.filter(t=>t.available);let r='<div class="smi-image-preview">';r+=`<img src="${i(s.src)}" alt="Preview" />`,r+=`<p class="smi-image-dimensions">${s.width} × ${s.height}</p>`,r+="</div>",r+='<div class="smi-options"><h3>Select Resolution</h3>',o.forEach((t,e)=>{const s=0===e?"checked":"";r+='<label class="smi-option">',r+=`<input type="radio" name="resolution" value="${t.resolution}" ${s}`,r+=` data-price="${t.price||0}"`,r+=` data-output-width="${t.output_width||""}"`,r+=` data-output-height="${t.output_height||""}">`,r+=`<span class="smi-option-label">${t.resolution}</span>`,r+=`<span class="smi-option-price">$${parseFloat(String(t.price)).toFixed(2)}</span>`,t.output_width&&t.output_height&&(r+=`<span class="smi-option-dims">${t.output_width} × ${t.output_height}</span>`),r+="</label>"}),r+="</div>",r+='<div class="smi-email-field">',r+='<label for="smi-email">Email (optional — for delivery confirmation)</label>',r+='<input type="email" id="smi-email" placeholder="your@email.com" />',r+="</div>",r+='<div class="smi-button-container">',r+='<button type="button" class="smi-btn smi-btn-primary smi-process-btn">Purchase &amp; Download</button>',r+="</div>",e.innerHTML=r,e.classList.remove("smi-hidden")},async processCheckout(){if(this.processing||!this.currentImage)return;const t=this.el.querySelector('input[name="resolution"]:checked');if(!t)return void this.showError("Please select a resolution option.");const e=(this.el.querySelector("#smi-email")?.value||"").trim();this.processing=!0,this.clearError();const i=this.el.querySelector(".smi-process-btn");i&&(i.disabled=!0,i.textContent="Creating checkout…");try{const i=await s("sell-my-images/create-checkout",{attachment_id:this.currentImage.attachmentId,post_id:this.currentImage.postId,resolution:t.value,email:e||void 0});i.checkout_url?this.showCheckoutRedirect(i):this.showError("No checkout URL returned. Please try again.")}catch(t){this.showError(t instanceof Error?t.message:"Checkout failed")}finally{this.processing=!1}},showCheckoutRedirect(t){const e=this.el.querySelector(".smi-modal-main");if(!e)return;let s='<div class="smi-checkout-redirect smi-status-container">';s+='<div class="smi-spinner"></div>',s+="<p>Redirecting to payment…</p>",s+=`<p>Amount: <strong>$${parseFloat(String(t.amount)).toFixed(2)}</strong></p>`,s+=`<a href="${i(t.checkout_url)}" class="smi-btn smi-btn-primary smi-checkout-link">Continue to Payment</a>`,s+='<p class="smi-redirect-note">If you are not redirected automatically, click the button above.</p>',s+="</div>",e.innerHTML=s,setTimeout(()=>{window.location.href=t.checkout_url},1500)},resetProcessButton(){const t=this.el.querySelector(".smi-process-btn");t&&(t.disabled=!1,t.textContent="Purchase & Download")},async trackClick(){if(this.currentImage)try{await s("sell-my-images/track-click",{post_id:this.currentImage.postId,attachment_id:this.currentImage.attachmentId})}catch{}},handleReturnFromStripe(){const t=new URLSearchParams(window.location.search),e=t.get("smi_job_id"),s=t.get("smi_status");if(!e)return;const i=new URL(window.location.href);i.searchParams.delete("smi_job_id"),i.searchParams.delete("smi_status"),window.history.replaceState({},"",i.toString()),"cancel"!==s&&(this.show(),this.showProcessingStatus(e))},showProcessingStatus(t){const e=this.el.querySelector(".smi-modal-main");e&&(e.innerHTML='<div class="smi-processing-status smi-status-container"><div class="smi-spinner"></div><p>Processing your image…</p></div>',e.classList.remove("smi-hidden"),this.showLoading(!1),this.pollJobStatus(t))},pollJobStatus(t){this.clearPoll();const e=async()=>{try{const i=await s("sell-my-images/get-job-status",{job_id:t},"GET");if("completed"===i.status)return void this.showCompleted(i);if("failed"===i.status)return void this.showError("Image processing failed. Please contact support.");this.pollTimer=setTimeout(e,3e3)}catch(t){this.showError("Could not check job status: "+(t instanceof Error?t.message:"Unknown error"))}};e()},showCompleted(t){const e=this.el.querySelector(".smi-modal-main");if(!e)return;let s='<div class="smi-completed smi-status-container">';s+='<div class="smi-success-icon">✅</div>',s+="<h3>Your image is ready!</h3>",s+="<p>Your high-resolution image is ready for download.</p>",t.download_url&&(s+=`<a href="${i(t.download_url)}" class="smi-btn smi-btn-primary" download>Download Image</a>`),s+="</div>",e.innerHTML=s,this.processing=!1},clearPoll(){this.pollTimer&&(clearTimeout(this.pollTimer),this.pollTimer=null)}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>o.init()):o.init()})();