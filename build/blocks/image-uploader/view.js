!function(){"use strict";document.querySelectorAll(".smi-image-uploader").forEach(function(e){!function(e){const t=e.querySelector("#smi-dropzone"),n=e.querySelector("#smi-file-input"),i=e.querySelector("#smi-browse-button"),o=e.querySelector("#smi-upload-zone"),r=e.querySelector("#smi-preview-zone"),l=e.querySelector("#smi-preview-image"),s=e.querySelector("#smi-remove-image"),a=e.querySelector("#smi-image-dimensions"),c=e.querySelector("#smi-resolution-picker"),u=e.querySelector("#smi-email-section"),d=e.querySelector("#smi-email-input"),p=e.querySelector("#smi-checkout-section"),m=e.querySelector("#smi-checkout-button"),y=e.querySelector("#smi-loading"),f=e.querySelector("#smi-loading-text"),g=e.querySelector("#smi-error"),h=e.querySelector("#smi-error-text");if(!(t&&n&&i&&o&&r&&l&&s&&m&&y&&g))return;let x=null,v=null;const S=1024*parseInt(e.dataset.maxFileSize||"10",10)*1024;function q(t){if(!["image/jpeg","image/png","image/webp"].includes(t.type))return void L("Please upload a JPEG, PNG, or WebP image.");if(t.size>S)return void L("File size exceeds "+S/1024/1024+"MB limit.");const n=new FileReader;n.onload=function(e){e.target&&e.target.result&&(l.src=e.target.result)},n.readAsDataURL(t),function(t){b("Uploading..."),P();const n=new FormData;n.append("image",t),fetch("/wp-json/smi/v1/upload-image",{method:"POST",body:n}).then(function(e){return e.json()}).then(function(t){var n;w(),t.success&&t.upload_id&&t.image_info?(x=t.upload_id,v=t.pricing||null,n=t.image_info,o.style.display="none",r.style.display="block",a&&(a.textContent=n.width+" × "+n.height+" px"),v&&function(){const t=e.querySelector("#smi-output-4x"),n=e.querySelector("#smi-output-8x"),i=e.querySelector("#smi-price-4x"),o=e.querySelector("#smi-price-8x");v?.["4x"]&&t&&i&&(t.textContent=v["4x"].output_width+" × "+v["4x"].output_height+" px",i.textContent="$"+v["4x"].price.toFixed(2)),v?.["8x"]&&n&&o&&(n.textContent=v["8x"].output_width+" × "+v["8x"].output_height+" px",o.textContent="$"+v["8x"].price.toFixed(2))}(),c&&(c.style.display="block"),u&&(u.style.display="block"),p&&(p.style.display="block")):(L(t.message||"Upload failed. Please try again."),C())}).catch(function(){w(),L("Upload failed. Please try again."),C()})}(t)}function k(){const t=e.querySelector('input[name="smi-resolution"]:checked'),n=t?.value||"4x",i=v?.[n]?.price??0;m.textContent="Checkout - $"+i.toFixed(2)}function C(){x=null,v=null,n.value="",l.src="",d&&(d.value=""),o.style.display="block",r.style.display="none",c&&(c.style.display="none"),u&&(u.style.display="none"),p&&(p.style.display="none");const t=e.querySelector('input[name="smi-resolution"][value="4x"]');t&&(t.checked=!0),m.textContent="Proceed to Checkout",P(),w()}function b(e){f&&(f.textContent=e),y.style.display="flex"}function w(){y.style.display="none"}function L(e){h&&(h.textContent=e),g.style.display="block"}function P(){g.style.display="none"}i.addEventListener("click",function(){n.click()}),n.addEventListener("change",function(e){const t=e.target;t.files&&t.files.length>0&&q(t.files[0])}),t.addEventListener("dragover",function(e){e.preventDefault(),t.classList.add("smi-dragover")}),t.addEventListener("dragleave",function(e){e.preventDefault(),t.classList.remove("smi-dragover")}),t.addEventListener("drop",function(e){e.preventDefault(),t.classList.remove("smi-dragover"),e.dataTransfer&&e.dataTransfer.files.length>0&&q(e.dataTransfer.files[0])}),s.addEventListener("click",C),m.addEventListener("click",function(){if(!x)return void L("Please upload an image first.");const t=e.querySelector('input[name="smi-resolution"]:checked'),n=t?.value||"4x",i=d?.value.trim()||"";b("Creating checkout..."),P();const o={upload_id:x,resolution:n};i&&(o.email=i),fetch("/wp-json/smi/v1/create-checkout-upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(function(e){return e.json()}).then(function(e){w(),e.success&&e.checkout_url?window.location.href=e.checkout_url:L(e.message||"Checkout failed. Please try again.")}).catch(function(){w(),L("Checkout failed. Please try again.")})}),e.querySelectorAll('input[name="smi-resolution"]').forEach(function(e){e.addEventListener("change",k)}),k()}(e)})}();